<div dir="rtl">

# توسعه ماژول هوشمند Wazuh برای شناسایی و واکنش خودکار به حملات Brute Force، DoS و Spoofing در پروتکل‌های SSH و SMTP بر بستر لینوکس

## مقدمه
این پروژه، یک ماژول هوشمند برای سیستم **Wazuh** است که به منظور شناسایی و واکنش خودکار به حملات **Brute Force**، **DoS** و **Spoofing** در پروتکل‌های **SSH** و **SMTP** طراحی و توسعه یافته است. این ماژول بر پایه لینوکس عمل می‌کند و با استفاده از **قوانین سفارشی (Custom Rules)**، **پاسخ‌های فعال (Active Responses)** و **مکانیزم‌های هشداردهی بلادرنگ**، امنیت سیستم‌های میزبان را افزایش می‌دهد.  

نسخه فعلی ماژول شامل **20 قانون سفارشی**، اسکریپت‌های اجرایی و ابزارهای تست است که عملکردی **پایدار و بدون خطا** ارائه می‌دهد. این ماژول برای محیط‌های عملیاتی طراحی شده و قابلیت یکپارچگی کامل با **Wazuh Manager نسخه 4.7 و بالاتر** را دارد.  

هدف اصلی، کاهش ریسک‌های امنیتی از طریق تشخیص سریع حملات و اعمال اقدامات واکنشی خودکار مانند **بلاک IP**، **محدودسازی نرخ درخواست‌ها** و **قرنطینه فعالیت‌های مشکوک** است.

---

## ویژگی‌های اصلی و مشخصات عمومی و فنی محصول پروژه

این ماژول با تمرکز بر تحلیل پیشرفته لاگ‌ها و پاسخ‌های هوشمند، ویژگی‌های زیر را ارائه می‌دهد:

### تحلیل مکانیزم‌های شناسایی و پاسخ به حملات Brute Force، DoS و Spoofing در پروتکل‌های SSH و SMTP
- روش‌های تحلیل لاگ‌های تلاش‌های ورود موفق و ناموفق در سرویس‌های **SSH** و **SMTP** بررسی می‌شود.  
- الگوهای رفتاری مهاجمین شامل **نرخ تلاش‌ها**، **حجم درخواست‌ها در واحد زمان** (برای شناسایی شاخص‌های DoS) و **بررسی فیلدهای هدر** برای تشخیص Spoofing در SMTP تحلیل می‌گردد.  
- تأثیر قوانین تشخیص این حملات بر **عملکرد سیستم** و **سربار پردازشی Wazuh** ارزیابی شده است تا تعادل مناسبی بین **امنیت** و **کارایی** برقرار شود.

### تحلیل ساختار Rule Engine در Wazuh و طراحی Ruleهای سفارشی
- قوانین پیش‌فرض Wazuh برای تشخیص **Brute Force**، **DoS** و **Spoofing** در پروتکل‌های **SSH** و **SMTP** مطالعه و تحلیل شده‌اند.  
- سپس، قوانین اختصاصی با **پارامترهای بهینه‌سازی‌شده** طراحی گردیده تا امکان **شناسایی دقیق حملات** و **کاهش هشدارهای کاذب** فراهم شود.  
- این بخش شامل تعریف ساختار شرط‌ها، نحوه شمارش تلاش‌ها، تعیین آستانه‌های تشخیص و جلوگیری از دور زدن قوانین است.  
- قوانین سفارشی در فایل **`local_rules.xml`** پیاده‌سازی شده و شامل گروه‌بندی‌هایی مانند `brute_force`، `dos`، `spoofing` و `correlation` می‌شود.

### طراحی معماری فنی ماژول شامل Ruleهای سفارشی، Active Response و سیستم هشداردهی بلادرنگ
ساختار ماژول به گونه‌ای طراحی شده که با **موتور قوانین داخلی Wazuh** یکپارچگی کامل داشته باشد. اجزای اصلی عبارتند از:  
- **قوانین سفارشی** برای Brute Force، DoS و Spoofing در **SSH** و **SMTP**  
- **اسکریپت‌های Bash** برای بلاک خودکار IP مهاجم:  
  - `block_ip.sh`  
  - `rate_limit.sh`  
- **قرنطینه ایمیل‌های مشکوک**: `quarantine_mail.sh`  
- **مکانیزم هشداردهی بلادرنگ** به مدیران امنیتی از طریق **ایمیل** یا ثبت در لاگ‌های SOC: `notify_soc.sh`  

طراحی ماژولار امکان **به‌روزرسانی سریع** و **سفارشی‌سازی متناسب با نیازهای امنیتی سازمان‌ها** را فراهم می‌سازد.

### تعریف سیاست‌های واکنش خودکار و ثبت وقایع امنیتی
- سیاست‌های واکنش شامل **بلاک فوری IPهای مهاجم**، **ثبت وقایع امنیتی مرتبط** در سامانه و **ایجاد هشدارهای مدیریتی** تدوین شده است.  
- این ساختار امکان **رهگیری تاریخچه حملات**، **اقدامات واکنشی** و **تحلیل روندهای امنیتی** را برای تیم‌های **SOC** و واحدهای امنیت سازمان تسهیل می‌کند.  
- **زمان‌بندی بلاک‌ها**:  
  - ۲ ساعت برای بلاک اولیه  
  - ۲۴ ساعت برای حملات توزیع‌شده  
- **ثبت پایدار بلوک‌ها** در فایل `blocked_ips.db` تضمین‌کننده **پایداری سیستم** است.

### پیاده‌سازی نهایی
در فاز پایانی، ماژول توسعه‌یافته بر روی محیط آزمایشی شامل **Wazuh Manager** و **Agentهای لینوکسی** نصب و تست شده است.  
حملات واقعی یا شبیه‌سازی‌شده **Brute Force**، **DoS** و **Spoofing** بر روی سرویس‌های **SSH** و **SMTP** اجرا گردیده و عملکرد قوانین و پاسخ‌های فعال ارزیابی شده است.  

نتایج تست‌ها شامل **صحت عملکرد**، **سرعت واکنش** و **نرخ خطای تشخیص** تحلیل و مستندسازی شده است.  
ابزار تست **`wazuh-ar-tester.sh`** برای بررسی واقعی عملکرد اسکریپت‌ها در محیط عملیاتی فراهم شده است.

---

این ماژول با استفاده از ابزارهایی مانند:  
- `ipset` برای بلاک پایدار IP  
- `iptables` برای محدودسازی نرخ  
- `sendmail`/`postfix` برای هشدارهای ایمیلی  

عملکردی **حرفه‌ای** ارائه می‌دهد.  
سازگاری با **MITRE ATT&CK** (مانند `T1110` برای Brute Force و `T1498` برای DoS) تضمین‌کننده **پوشش جامع تهدیدات** است.

---

## پیش‌نیازها
برای نصب و اجرای این ماژول، موارد زیر ضروری است:

- **Wazuh Manager** نسخه **4.7 یا بالاتر**، نصب‌شده و فعال بر روی سیستم لینوکسی (توصیه‌شده: Ubuntu/Debian).  
- **دسترسی root یا sudo** برای نصب وابستگی‌ها و کپی فایل‌ها.  
- **وابستگی‌های نرم‌افزاری**:  
  - `sendmail` (برای هشدارهای ایمیل)  
  - `postfix` (برای شبیه‌سازی SMTP)  
  - `ipset` (برای بلاک پایدار IP)  
  - `python3` (برای پردازش JSON)  
- **سرویس‌های SSH و SMTP** (مانند Postfix) باید فعال باشند تا قوانین اعمال شوند.  
- فضای کافی در مسیرهای **`/var/ossec`** برای لاگ‌ها و فایل‌های قرنطینه.

---

## روش‌های نصب

### 1. نصب اتوماتیک با اسکریپت `install.sh`
این روش تمام مراحل را به صورت **خودکار** انجام می‌دهد، وابستگی‌ها را بررسی و نصب می‌کند، فایل‌ها را کپی می‌نماید و Wazuh را راه‌اندازی مجدد می‌کند.

#### مراحل:
1. فایل `install.sh` را در یک دایرکتوری مناسب کپی کنید (مثلاً `/tmp`).  
2. مجوز اجرایی بدهید:  

   chmod +x install.sh  
3. اسکریپت را با `sudo` اجرا کنید:  

   sudo ./install.sh  

#### اسکریپت به طور خودکار:
- **Wazuh Manager** را بررسی و در صورت نیاز نصب می‌کند.  
- وابستگی‌ها (`sendmail`، `postfix`، `ipset`، `python3`) را نصب می‌کند.  
- قوانین سفارشی (`local_rules.xml`) را به **`/var/ossec/etc/rules`** کپی می‌کند.  
- اسکریپت‌های Active Response (`block_ip.sh`، `rate_limit.sh`، `quarantine_mail.sh`، `notify_soc.sh`) را به **`/var/ossec/active-response/bin`** کپی می‌کند.  
- ابزار تست (`wazuh-ar-tester.sh`) را به **`/var/ossec/bin`** کپی می‌کند.  
- **Wazuh Manager** را راه‌اندازی مجدد می‌کند.  

> **پس از نصب**، پیام موفقیت‌آمیز نمایش داده می‌شود و پیشنهادهایی برای تست ارائه می‌گردد.  

> **نکته:** در صورت وجود خطا، لاگ‌ها را در **`/var/ossec/logs`** بررسی کنید. این روش کاربر را برای نصب وابستگی‌ها راهنمایی می‌کند.

---

### 2. نصب دستی بدون اسکریپت
این روش برای **کاربران پیشرفته** مناسب است و امکان **سفارشی‌سازی فایل‌ها قبل از کپی** را فراهم می‌کند.

#### مراحل:
1. **وابستگی‌ها را دستی نصب کنید**:  

   sudo apt update && sudo apt install -y sendmail postfix ipset python3  

2. **Wazuh Manager را بررسی کنید**:  
   مطمئن شوید سرویس `wazuh-manager` فعال است:  

   systemctl status wazuh-manager  
   اگر نصب نشده، از اسکریپت رسمی Wazuh استفاده کنید:  

   curl -sO https://packages.wazuh.com/4.x/install.sh && sudo bash install.sh  

3. **فایل قوانین سفارشی را کپی کنید**:  

   sudo cp local_rules.xml /var/ossec/etc/rules/local_rules.xml  

4. **اسکریپت‌های Active Response را کپی کنید**:  

   sudo mkdir -p /var/ossec/active-response/bin  
   sudo cp block_ip.sh rate_limit.sh quarantine_mail.sh notify_soc.sh /var/ossec/active-response/bin/  

5. **مجوزها را تنظیم کنید**:  

   sudo chown -R root:wazuh /var/ossec/active-response/bin/ && sudo chmod 750 /var/ossec/active-response/bin/*.sh  

6. **ابزار تست را کپی کنید**:  

   sudo cp wazuh-ar-tester.sh /var/ossec/bin/ && sudo chmod 750 /var/ossec/bin/wazuh-ar-tester.sh  

7. **فایل پیکربندی `ossec.conf` را بررسی و بخش‌های مربوط به Active Responses و Email Alerts را به‌روزرسانی کنید** (مانند افزودن `command`ها و `active-response`ها).  

8. **Wazuh Manager را راه‌اندازی مجدد کنید**:  

   sudo systemctl restart wazuh-manager  

> **نکته:** در روش دستی، فایل **`ossec.conf`** را برای تنظیم ایمیل (`smtp_server`، `email_from`، `email_to`) و قوانین سفارشی ویرایش کنید تا با محیط شما سازگار شود.

---

## پیکربندی پس از نصب

- **فایل `/var/ossec/etc/ossec.conf` را برای تنظیم هشدارهای ایمیل ویرایش کنید** (بخش `<email_notification>`).  
- **برای تست، از ابزار `wazuh-ar-tester.sh` استفاده کنید**:  

  sudo /var/ossec/bin/wazuh-ar-tester.sh  
  این ابزار عملکرد واقعی اسکریپت‌ها را با IPهای آزمایشی بررسی می‌کند.  
- **لاگ‌های هشدارها را در `/var/ossec/logs/alerts/alerts.log` مشاهده کنید**.  
- **برای قرنطینه، دایرکتوری `/var/ossec/quarantine` را بررسی کنید**.  
- **هشدارهای SOC در `/var/ossec/soc_alerts.log` ثبت می‌شوند**.

---

## تست و استفاده

- **تست**: حملات شبیه‌سازی‌شده **Brute Force** (مانند تلاش‌های ورود متعدد به SSH) یا **DoS** (درخواست‌های زیاد به SMTP) را اجرا کنید و واکنش‌ها را بررسی نمایید.  
- **مشاهده لاگ‌ها**:  

  tail -f /var/ossec/logs/active-responses.log  
- **سلامت سیستم**: قانون **ID 100099** برای بررسی سلامت ماژول استفاده می‌شود.  

> **در صورت بروز مشکل**، وابستگی‌ها و مجوز فایل‌ها را بررسی کنید.

</div>